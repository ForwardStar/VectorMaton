# Substring-ANN
An elegant vector database that supports hybrid queries of ANNs whose associated strings contain a queried substring. Each data in the vector database consists of a string and a vector. Each query contains a string, a vector, and an integer k to return kNNs. The query results will contain data that involves the queried string as a substring, and its vector is a k-nearest neighbor of the queried vector under the substring constraint.

Example:
- In bioinformatics, each protein can be represented by (ùë†,ùë£), where ùë† is its amino acid sequence (e.g., Leu-Ser-Met) and ùë£ is its 2D or 3D structural embedding (e.g., AlphaFold embeddings);

- Query: searching the most similar protein structure containing a specific motif (i.e., a substring of amino acid sequence).


# Compile and run
We developed and tested this vector database under ``GCC 10.5.0`` with ``O3`` optimization. To compile the codes, simply run:
```sh
mkdir build && cd build
cmake ..
make
```

This will generate executable files ``nsw_test``, ``sa_test`` and ``db_test``. In particular, ``db_test`` corresponds to ``source/test_vector_db.cpp``, which provides a demo on how to use the vector database.

# Datasets
We include several datasets for experiments:
- [CodeSearchNet](https://huggingface.co/datasets/irds/codesearchnet): a dataset of code snippets and their embeddings; to be specific, each data consists of a function name as its string and a code embedding vector (generated by CodeBERT) as its vector;

We provide a Python script ``generate_datasets.py`` to download and generate aforementioned datasets. The generated datasets are stored in the ``datasets/`` folder. Each dataset contains a file ``vectors.txt`` and a file ``strings.txt``, where the i-th line of ``vectors.txt`` and the i-th line of ``strings.txt`` correspond to the vector and string of the i-th data, respectively. To execute the script, please first install the required ``datasets``, ``numpy``, ``transformers`` and ``torch`` packages via:
```sh
pip install datasets numpy transformers torch
```

Then run:
```sh
python3 generate_datasets.py
```

Note that the script may take hours to finish, as it needs to download the dataset and compute the embeddings.

# APIs
Refer to ``source/test_vector_db.cpp`` as a demo example.

Include the header file:
```cpp
#include "substring-ANN/source/vector_db.h"
```

Initiate a vector DB instance:
```cpp
VectorDB db;
```

Insert a vector with its associated string (possibly empty, which is then in line with the basic vector database with no substring query support):
```cpp
// Interface
// int insert(const std::vector<float>& vec, const std::string &s);

// Example
int id = db.insert({1.0, 2.0, 3.0}, "banana"); // automatically generate a unique `id` for the data
```

Remove data:
```cpp
// Interface
// void remove(int id);

// Example
db.remove(0);
```

Query the kNNs of a vector with a substring constraint:
```cpp
// Interface
// std::vector<int> query(const std::vector<float>& vec, const std::string &s, int k);

// Example
std::vector<int> res = db.query({9.0, 10.0, 11.0}, "ana", 2) // `res` contains the data `id`s of the queried result
```